<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ResiumEntityContextMenu Test</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.development.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.development.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .test-container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        
        .test-area {
            border: 2px dashed #ddd;
            padding: 40px;
            margin: 20px 0;
            border-radius: 8px;
            text-align: center;
            background: #fafafa;
            position: relative;
            min-height: 200px;
        }
        
        .test-button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            margin: 10px;
            font-size: 16px;
            transition: background 0.3s;
        }
        
        .test-button:hover {
            background: #45a049;
        }
        
        .test-button.secondary {
            background: #2196F3;
        }
        
        .test-button.secondary:hover {
            background: #1976D2;
        }
        
        .info-panel {
            background: #e3f2fd;
            border: 1px solid #bbdefb;
            border-radius: 6px;
            padding: 15px;
            margin: 20px 0;
        }
        
        .menu-demo {
            display: inline-block;
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 20px;
            margin: 10px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .menu-demo:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .resium-entity-contextmenu {
            font-family: Arial, sans-serif;
            font-size: 14px;
        }
        
        .resium-entity-contextmenu button:hover {
            background: #e3f2fd !important;
        }
        
        .log {
            background: #f5f5f5;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px;
            margin-top: 20px;
            max-height: 200px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
        
        .entity-box {
            display: inline-block;
            background: linear-gradient(45deg, #FF6B6B, #4ECDC4);
            color: white;
            padding: 20px;
            margin: 10px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }
        
        .entity-box:hover {
            transform: scale(1.05);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }
        
        .entity-box::after {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            background: linear-gradient(45deg, #FF6B6B, #4ECDC4, #45B7D1, #96CEB4);
            border-radius: 8px;
            z-index: -1;
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .entity-box:hover::after {
            opacity: 1;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>üåç ResiumEntityContextMenu Test</h1>
        
        <div class="info-panel">
            <h3>Test-Anweisungen:</h3>
            <ul>
                <li><strong>Rechtsklick:</strong> √ñffnet Context Menu</li>
                <li><strong>Linksklick:</strong> √ñffnet Menu (bei entsprechender Konfiguration)</li>
                <li><strong>Hover:</strong> √ñffnet Menu nach kurzer Verz√∂gerung</li>
                <li><strong>ESC-Taste:</strong> Schlie√üt das Menu</li>
                <li><strong>Pfeiltasten:</strong> Navigation im Menu</li>
                <li><strong>Enter:</strong> Auswahl best√§tigen</li>
            </ul>
        </div>

        <div id="root"></div>
    </div>

    <script type="text/babel">
        const { useState, useCallback, useRef } = React;

        // Mock Entity f√ºr Tests
        const mockEntity = {
            id: 'test-entity-1',
            name: 'Test POI',
            position: {
                getValue: () => ({ x: 0, y: 0, z: 0 })
            }
        };

        // Menu Items Generator
        const getMenuItems = async (entity) => {
            // Simuliere asynchrones Laden
            await new Promise(resolve => setTimeout(resolve, 200));
            
            return [
                {
                    id: 'info',
                    label: 'Informationen anzeigen',
                    icon: '‚ÑπÔ∏è'
                },
                {
                    id: 'separator1',
                    separator: true
                },
                {
                    id: 'edit',
                    label: 'Bearbeiten',
                    icon: '‚úèÔ∏è'
                },
                {
                    id: 'duplicate',
                    label: 'Duplizieren',
                    icon: 'üìã'
                },
                {
                    id: 'separator2',
                    separator: true
                },
                {
                    id: 'delete',
                    label: 'L√∂schen',
                    icon: 'üóëÔ∏è',
                    disabled: false
                },
                {
                    id: 'disabled',
                    label: 'Deaktiviert',
                    icon: '‚ùå',
                    disabled: true
                }
            ];
        };

        // Custom Menu Item Renderer
        const customMenuRenderer = (item) => (
            <div style={{ 
                display: 'flex', 
                alignItems: 'center', 
                gap: '10px',
                fontSize: '14px'
            }}>
                {item.icon && <span style={{ fontSize: '16px' }}>{item.icon}</span>}
                <span style={{ flex: 1 }}>{item.label}</span>
                {item.id === 'delete' && <kbd style={{ 
                    background: '#f0f0f0', 
                    padding: '2px 6px', 
                    borderRadius: '3px',
                    fontSize: '11px'
                }}>Del</kbd>}
            </div>
        );

        // ResiumEntityContextMenu Component (inline f√ºr Demo)
        const ResiumEntityContextMenu = ({ 
            entity,
            getMenuItems,
            renderMenuItem,
            onSelect,
            openOn = 'rightClick',
            positionOffset = { x: 4, y: 4 },
            portal = true,
            closeOnOutsideClick = true,
            keyboardNavigation = true,
            className = '',
            style = {},
            disabled = false,
            zIndex = 3000,
            viewer = null,
            hoverDelay = 250,
            longPressDuration = 500
        }) => {
            const [open, setOpen] = useState(false);
            const [x, setX] = useState(0);
            const [y, setY] = useState(0);
            const [items, setItems] = useState(null);
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState(null);
            const [focusIndex, setFocusIndex] = useState(-1);

            const callIdRef = useRef(0);
            const menuRef = useRef(null);
            const itemsRefs = useRef([]);
            const hoverTimerRef = useRef(null);

            const loadMenuItems = useCallback(async (entityArg) => {
                const myCall = ++callIdRef.current;
                setLoading(true);
                setError(null);
                setItems(null);
                
                try {
                    const res = await getMenuItems(entityArg);
                    
                    if (callIdRef.current === myCall) {
                        setItems(res || []);
                        setLoading(false);
                        setError(null);
                        
                        const firstIndex = (res || []).findIndex((it) => !it.disabled && !it.separator);
                        setFocusIndex(firstIndex >= 0 ? firstIndex : -1);
                    }
                } catch (e) {
                    if (callIdRef.current === myCall) {
                        setItems(null);
                        setLoading(false);
                        setError('Fehler beim Laden');
                    }
                }
            }, [getMenuItems]);

            const openMenuAt = useCallback(async (clientX, clientY) => {
                if (disabled) return;
                
                setX(clientX + positionOffset.x);
                setY(clientY + positionOffset.y);
                setOpen(true);
                
                await loadMenuItems(entity);
            }, [disabled, entity, loadMenuItems, positionOffset]);

            const closeMenu = useCallback(() => {
                setOpen(false);
                setItems(null);
                setLoading(false);
                setError(null);
                setFocusIndex(-1);
                callIdRef.current++;
            }, []);

            const handleItemSelect = async (item) => {
                try {
                    await onSelect?.(item, entity);
                } catch (error) {
                    console.error('Error selecting menu item:', error);
                } finally {
                    closeMenu();
                }
            };

            // Click outside to close
            React.useEffect(() => {
                if (!open || !closeOnOutsideClick) return;
                
                const onDocClick = (e) => {
                    if (menuRef.current?.contains(e.target)) return;
                    closeMenu();
                };
                
                document.addEventListener('mousedown', onDocClick);
                return () => document.removeEventListener('mousedown', onDocClick);
            }, [open, closeOnOutsideClick, closeMenu]);

            // Event handlers
            React.useEffect(() => {
                if (disabled) return;
                
                const getCoordinates = (ev) => {
                    if ('clientX' in ev) {
                        return { x: ev.clientX, y: ev.clientY };
                    }
                    if (ev.touches && ev.touches.length > 0) {
                        return { x: ev.touches[0].clientX, y: ev.touches[0].clientY };
                    }
                    return { x: window.innerWidth / 2, y: window.innerHeight / 2 };
                };

                const onContextMenu = (ev) => {
                    if (openOn !== 'rightClick') return;
                    ev.preventDefault();
                    const coords = getCoordinates(ev);
                    void openMenuAt(coords.x, coords.y);
                };

                const onLeftClick = (ev) => {
                    if (openOn !== 'leftClick' || ev.button !== 0) return;
                    const coords = getCoordinates(ev);
                    void openMenuAt(coords.x, coords.y);
                };

                const onMouseMove = (ev) => {
                    if (openOn !== 'hover') return;
                    
                    if (hoverTimerRef.current) {
                        clearTimeout(hoverTimerRef.current);
                    }
                    
                    const coords = getCoordinates(ev);
                    hoverTimerRef.current = setTimeout(() => {
                        void openMenuAt(coords.x, coords.y);
                    }, hoverDelay);
                };

                document.addEventListener('contextmenu', onContextMenu);
                document.addEventListener('click', onLeftClick);
                document.addEventListener('mousemove', onMouseMove);

                return () => {
                    document.removeEventListener('contextmenu', onContextMenu);
                    document.removeEventListener('click', onLeftClick);
                    document.removeEventListener('mousemove', onMouseMove);
                    
                    if (hoverTimerRef.current) clearTimeout(hoverTimerRef.current);
                };
            }, [openOn, openMenuAt, hoverDelay, disabled]);

            // Keyboard navigation
            React.useEffect(() => {
                if (!open || !keyboardNavigation || !items) return;
                
                const onKey = (ev) => {
                    if (ev.key === 'Escape') {
                        ev.preventDefault();
                        closeMenu();
                        return;
                    }
                    
                    const visibleItems = items.filter((it) => !it.disabled && !it.separator);
                    if (visibleItems.length === 0) return;
                    
                    if (ev.key === 'ArrowDown') {
                        ev.preventDefault();
                        let next = focusIndex;
                        for (let i = 1; i <= items.length; i++) {
                            const idx = (focusIndex + i) % items.length;
                            const it = items[idx];
                            if (!it.disabled && !it.separator) {
                                next = idx;
                                break;
                            }
                        }
                        setFocusIndex(next);
                    } else if (ev.key === 'ArrowUp') {
                        ev.preventDefault();
                        let prev = focusIndex;
                        for (let i = 1; i <= items.length; i++) {
                            const idx = (focusIndex - i + items.length) % items.length;
                            const it = items[idx];
                            if (!it.disabled && !it.separator) {
                                prev = idx;
                                break;
                            }
                        }
                        setFocusIndex(prev);
                    } else if (ev.key === 'Enter') {
                        ev.preventDefault();
                        const it = items[focusIndex];
                        if (it && !it.disabled && !it.separator) {
                            handleItemSelect(it);
                        }
                    }
                };
                
                document.addEventListener('keydown', onKey);
                return () => document.removeEventListener('keydown', onKey);
            }, [open, keyboardNavigation, items, focusIndex]);

            // Focus management
            React.useEffect(() => {
                if (!open || focusIndex < 0 || !items) return;
                
                requestAnimationFrame(() => {
                    itemsRefs.current[focusIndex]?.focus();
                });
            }, [focusIndex, open, items]);

            if (!open) return null;

            const menuContent = (
                <div
                    ref={menuRef}
                    role="menu"
                    className={`resium-entity-contextmenu ${className}`}
                    style={{
                        position: 'fixed',
                        left: x,
                        top: y,
                        zIndex,
                        minWidth: 180,
                        padding: 8,
                        backgroundColor: 'white',
                        border: '1px solid #ddd',
                        borderRadius: 8,
                        boxShadow: '0 4px 12px rgba(0,0,0,0.15)',
                        outline: 'none',
                        ...style,
                    }}
                >
                    {loading && (
                        <div style={{ padding: '8px 12px', color: '#666' }}>
                            Laden...
                        </div>
                    )}
                    
                    {error && (
                        <div style={{ padding: '8px 12px', color: '#d32f2f' }}>
                            {error}
                        </div>
                    )}
                    
                    {!loading && !error && items && items.length === 0 && (
                        <div style={{ padding: '8px 12px', color: '#666' }}>
                            Keine Aktionen verf√ºgbar
                        </div>
                    )}
                    
                    {!loading && !error && items && items.length > 0 && (
                        <div>
                            {items.map((item, idx) => {
                                if (item.separator) {
                                    return (
                                        <div 
                                            key={`separator-${idx}`}
                                            style={{ 
                                                height: 1, 
                                                backgroundColor: '#eee', 
                                                margin: '4px 0' 
                                            }} 
                                        />
                                    );
                                }

                                const isDisabled = !!item.disabled;
                                const isFocused = focusIndex === idx;
                                
                                return (
                                    <button
                                        key={item.id}
                                        ref={(el) => (itemsRefs.current[idx] = el)}
                                        role="menuitem"
                                        disabled={isDisabled}
                                        tabIndex={-1}
                                        onClick={() => !isDisabled && handleItemSelect(item)}
                                        onMouseEnter={() => setFocusIndex(idx)}
                                        style={{
                                            display: 'block',
                                            width: '100%',
                                            padding: '8px 12px',
                                            border: 'none',
                                            backgroundColor: isFocused ? '#f5f5f5' : 'transparent',
                                            textAlign: 'left',
                                            cursor: isDisabled ? 'not-allowed' : 'pointer',
                                            borderRadius: 4,
                                            opacity: isDisabled ? 0.5 : 1,
                                        }}
                                    >
                                        {renderMenuItem ? renderMenuItem(item) : (
                                            <div style={{ display: 'flex', alignItems: 'center', gap: 8 }}>
                                                {item.icon && <span>{item.icon}</span>}
                                                <span>{item.label}</span>
                                            </div>
                                        )}
                                    </button>
                                );
                            })}
                        </div>
                    )}
                </div>
            );

            return portal ? ReactDOM.createPortal(menuContent, document.body) : menuContent;
        };

        // Test App Component
        const TestApp = () => {
            const [logs, setLogs] = useState([]);
            const [currentMode, setCurrentMode] = useState('rightClick');

            const addLog = useCallback((message) => {
                setLogs(prev => [...prev, `${new Date().toLocaleTimeString()}: ${message}`]);
            }, []);

            const handleMenuSelect = useCallback((item, entity) => {
                addLog(`Ausgew√§hlt: ${item.label} (Entity: ${entity?.id || entity || 'none'})`);
            }, [addLog]);

            const clearLogs = () => setLogs([]);

            return (
                <div>
                    <div className="test-area">
                        <h3>üéØ Interactive Test Area</h3>
                        <p>Aktiver Modus: <strong>{currentMode}</strong></p>
                        
                        <div style={{ margin: '20px 0' }}>
                            <button 
                                className="test-button"
                                onClick={() => setCurrentMode('rightClick')}
                            >
                                Rechtsklick-Modus
                            </button>
                            <button 
                                className="test-button secondary"
                                onClick={() => setCurrentMode('leftClick')}
                            >
                                Linksklick-Modus
                            </button>
                            <button 
                                className="test-button secondary"
                                onClick={() => setCurrentMode('hover')}
                            >
                                Hover-Modus
                            </button>
                        </div>

                        <div style={{ display: 'flex', flexWrap: 'wrap', justifyContent: 'center', gap: '10px' }}>
                            <div className="entity-box">
                                <strong>Entity A</strong>
                                <br />
                                <small>POI #001</small>
                            </div>
                            <div className="entity-box">
                                <strong>Entity B</strong>
                                <br />
                                <small>POI #002</small>
                            </div>
                            <div className="entity-box">
                                <strong>Entity C</strong>
                                <br />
                                <small>POI #003</small>
                            </div>
                        </div>

                        <ResiumEntityContextMenu
                            entity={mockEntity}
                            getMenuItems={getMenuItems}
                            renderMenuItem={customMenuRenderer}
                            onSelect={handleMenuSelect}
                            openOn={currentMode}
                            hoverDelay={300}
                            longPressDuration={800}
                        />
                    </div>

                    <div className="info-panel">
                        <h4>üìã Event Log</h4>
                        <button 
                            className="test-button" 
                            onClick={clearLogs}
                            style={{ float: 'right', padding: '4px 12px', fontSize: '12px' }}
                        >
                            L√∂schen
                        </button>
                        <div className="log">
                            {logs.length === 0 ? (
                                <div style={{ color: '#999', fontStyle: 'italic' }}>
                                    Keine Events bisher...
                                </div>
                            ) : (
                                logs.map((log, idx) => (
                                    <div key={idx}>{log}</div>
                                ))
                            )}
                        </div>
                    </div>

                    <div className="info-panel">
                        <h4>üöÄ Feature Tests</h4>
                        <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(200px, 1fr))', gap: '10px' }}>
                            <div>
                                <h5>‚úÖ Implementierte Features:</h5>
                                <ul style={{ fontSize: '12px', margin: 0 }}>
                                    <li>Rechtsklick Context Menu</li>
                                    <li>Linksklick Aktivierung</li>
                                    <li>Hover-basierte √ñffnung</li>
                                    <li>Keyboard Navigation (‚Üë‚Üì)</li>
                                    <li>ESC zum Schlie√üen</li>
                                    <li>Click-outside zum Schlie√üen</li>
                                    <li>Asynchrone Menu Items</li>
                                    <li>Custom Menu Renderer</li>
                                    <li>Disabled Items</li>
                                    <li>Separator Support</li>
                                </ul>
                            </div>
                            <div>
                                <h5>üé® Styling Features:</h5>
                                <ul style={{ fontSize: '12px', margin: 0 }}>
                                    <li>Responsive Positioning</li>
                                    <li>Smooth Hover Effects</li>
                                    <li>Focus Indication</li>
                                    <li>Loading States</li>
                                    <li>Error Handling</li>
                                    <li>Portal Rendering</li>
                                    <li>Custom Z-Index</li>
                                    <li>Accessible ARIA</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        ReactDOM.render(<TestApp />, document.getElementById('root'));
    </script>
</body>
</html>