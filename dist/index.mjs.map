{"version":3,"sources":["../src/components/EntityContextMenu.tsx","../src/hooks/useEntityContextMenu.tsx","../src/contexts/ContextMenuProvider.tsx"],"sourcesContent":["import { useRef, useState, useEffect, useCallback } from 'react';\r\nimport { useEntityContextMenu } from '../hooks/useEntityContextMenu';\r\nimport { MenuItem } from '../types/index';\r\n\r\nexport const EntityContextMenu: React.FC<{ className?: string }> = ({ className = '' }) => {\r\n  const { isVisible, context, menuItems, isLoading, hideMenu } = useEntityContextMenu();\r\n  const menuRef = useRef<HTMLDivElement>(null);\r\n  const [focusedIndex, setFocusedIndex] = useState(0);\r\n  const [openSubmenu, setOpenSubmenu] = useState<string | null>(null);\r\n  const [menuPosition, setMenuPosition] = useState({ x: 0, y: 0 });\r\n\r\n  // Calculate position with viewport clamping\r\n  useEffect(() => {\r\n    if (!isVisible || !context) return;\r\n\r\n    const menuEl = menuRef.current;\r\n    if (!menuEl) {\r\n      setMenuPosition({ x: context.position.x, y: context.position.y });\r\n      return;\r\n    }\r\n\r\n    // Use RAF to ensure DOM is ready\r\n    requestAnimationFrame(() => {\r\n      const rect = menuEl.getBoundingClientRect();\r\n      const viewportWidth = window.innerWidth;\r\n      const viewportHeight = window.innerHeight;\r\n\r\n      let x = context.position.x;\r\n      let y = context.position.y;\r\n\r\n      // Flip horizontally if needed\r\n      if (x + rect.width > viewportWidth - 10) {\r\n        x = Math.max(10, x - rect.width);\r\n      }\r\n\r\n      // Flip vertically if needed\r\n      if (y + rect.height > viewportHeight - 10) {\r\n        y = Math.max(10, y - rect.height);\r\n      }\r\n\r\n      setMenuPosition({ x, y });\r\n    });\r\n  }, [isVisible, context, menuItems]);\r\n\r\n  // Handle click outside\r\n  useEffect(() => {\r\n    if (!isVisible) return;\r\n\r\n    const handleClickOutside = (e: MouseEvent) => {\r\n      if (menuRef.current && !menuRef.current.contains(e.target as Node)) {\r\n        hideMenu();\r\n      }\r\n    };\r\n\r\n    const handleEscape = (e: KeyboardEvent) => {\r\n      if (e.key === 'Escape') {\r\n        hideMenu();\r\n      }\r\n    };\r\n\r\n    document.addEventListener('mousedown', handleClickOutside);\r\n    document.addEventListener('keydown', handleEscape);\r\n\r\n    return () => {\r\n      document.removeEventListener('mousedown', handleClickOutside);\r\n      document.removeEventListener('keydown', handleEscape);\r\n    };\r\n  }, [isVisible, hideMenu]);\r\n\r\n  // Focus management\r\n  useEffect(() => {\r\n    if (isVisible && menuRef.current) {\r\n      menuRef.current.focus();\r\n    }\r\n  }, [isVisible]);\r\n\r\n  // Keyboard navigation\r\n  const handleKeyDown = useCallback(\r\n    (e: React.KeyboardEvent) => {\r\n      if (!menuItems || menuItems.length === 0) return;\r\n\r\n      const visibleItems = menuItems.filter(\r\n        (item) => item.type !== 'separator' && (!item.visible || item.visible(context!)),\r\n      );\r\n\r\n      switch (e.key) {\r\n        case 'ArrowDown':\r\n          e.preventDefault();\r\n          setFocusedIndex((prev) => (prev + 1) % visibleItems.length);\r\n          break;\r\n        case 'ArrowUp':\r\n          e.preventDefault();\r\n          setFocusedIndex((prev) => (prev - 1 + visibleItems.length) % visibleItems.length);\r\n          break;\r\n        case 'Enter':\r\n        case ' ':\r\n          e.preventDefault();\r\n          const focusedItem = visibleItems[focusedIndex];\r\n          if (\r\n            focusedItem &&\r\n            focusedItem.enabled &&\r\n            focusedItem.enabled(context!) !== false &&\r\n            (!focusedItem.enabled || focusedItem.enabled(context!))\r\n          ) {\r\n            if (focusedItem.type === 'submenu' && focusedItem.items) {\r\n              setOpenSubmenu(focusedItem.id);\r\n            } else if (focusedItem.onClick) {\r\n              focusedItem.onClick(context!);\r\n              hideMenu();\r\n            }\r\n          }\r\n          break;\r\n        case 'ArrowRight':\r\n          const item = visibleItems[focusedIndex];\r\n          if (item?.type === 'submenu' && item.items) {\r\n            setOpenSubmenu(item.id);\r\n          }\r\n          break;\r\n        case 'ArrowLeft':\r\n          setOpenSubmenu(null);\r\n          break;\r\n      }\r\n    },\r\n    [menuItems, context, focusedIndex, hideMenu],\r\n  );\r\n\r\n  if (!isVisible) return null;\r\n\r\n  const renderMenuItem = (item: MenuItem, index: number): React.ReactNode => {\r\n    if (!context) return null;\r\n\r\n    // Check visibility\r\n    if (item.visible && !item.visible(context)) {\r\n      return null;\r\n    }\r\n\r\n    // Check if enabled\r\n    const isEnabled = item.enabled === undefined || item.enabled(context);\r\n    const isFocused = index === focusedIndex;\r\n\r\n    if (item.type === 'separator') {\r\n      return <div key={item.id} className=\"h-px bg-gray-200 my-1\" />;\r\n    }\r\n\r\n    if (item.type === 'custom' && item.render) {\r\n      return <div key={item.id}>{item.render(context)}</div>;\r\n    }\r\n\r\n    const handleClick = async () => {\r\n      if (!isEnabled) return;\r\n\r\n      if (item.type === 'submenu' && item.items) {\r\n        setOpenSubmenu(openSubmenu === item.id ? null : item.id);\r\n      } else if (item.onClick) {\r\n        await item.onClick(context);\r\n        hideMenu();\r\n      }\r\n    };\r\n\r\n    return (\r\n      <div\r\n        key={item.id}\r\n        role=\"menuitem\"\r\n        tabIndex={isFocused ? 0 : -1}\r\n        className={`\r\n          px-3 py-2 cursor-pointer select-none relative\r\n          ${isEnabled ? 'hover:bg-blue-50' : 'opacity-50 cursor-not-allowed'}\r\n          ${isFocused ? 'bg-blue-100' : ''}\r\n          ${item.type === 'toggle' && item.checked ? 'pl-8' : ''}\r\n        `}\r\n        onClick={handleClick}\r\n        onMouseEnter={() => setFocusedIndex(index)}\r\n      >\r\n        {item.type === 'toggle' && item.checked && <span className=\"absolute left-2\">✓</span>}\r\n        <span className=\"flex items-center justify-between\">\r\n          {item.label}\r\n          {item.type === 'submenu' && <span className=\"ml-4\">▶</span>}\r\n        </span>\r\n\r\n        {item.type === 'submenu' && openSubmenu === item.id && item.items && (\r\n          <div className=\"absolute left-full top-0 ml-1 bg-white border border-gray-200 rounded-lg shadow-lg min-w-[150px] z-50\">\r\n            {item.items.map((subItem, subIndex) => renderMenuItem(subItem, subIndex))}\r\n          </div>\r\n        )}\r\n      </div>\r\n    );\r\n  };\r\n\r\n  return (\r\n    <div\r\n      ref={menuRef}\r\n      role=\"menu\"\r\n      tabIndex={-1}\r\n      className={`\r\n        fixed bg-white border border-gray-200 rounded-lg shadow-lg\r\n        min-w-[200px] max-w-[300px] z-[9999] outline-none\r\n        ${className}\r\n      `}\r\n      style={{\r\n        left: `${menuPosition.x}px`,\r\n        top: `${menuPosition.y}px`,\r\n      }}\r\n      onKeyDown={handleKeyDown}\r\n    >\r\n      {isLoading ? (\r\n        <div className=\"px-3 py-4 text-center text-gray-500\">Loading menu...</div>\r\n      ) : menuItems && menuItems.length > 0 ? (\r\n        <div className=\"py-1\">{menuItems.map((item, index) => renderMenuItem(item, index))}</div>\r\n      ) : (\r\n        <div className=\"px-3 py-4 text-center text-gray-500\">No actions available</div>\r\n      )}\r\n    </div>\r\n  );\r\n};\r\n","import { useContext } from 'react';\r\nimport { ContextMenuContext } from '../contexts/ContextMenuProvider';\r\n\r\nexport function useEntityContextMenu() {\r\n  const context = useContext(ContextMenuContext);\r\n  if (!context) {\r\n    throw new Error('useEntityContextMenu must be used within EntityContextMenuProvider');\r\n  }\r\n  return context;\r\n}\r\n","import { createContext, useState, useCallback } from 'react';\r\nimport {\r\n  ContextMenuState,\r\n  EntityContext,\r\n  MenuFactory,\r\n  MenuItem,\r\n  EntityContextMenuProviderProps,\r\n} from '../types/index';\r\n\r\nexport const ContextMenuContext = createContext<ContextMenuState | null>(null);\r\n\r\nexport const EntityContextMenuProvider: React.FC<EntityContextMenuProviderProps> = ({\r\n  children,\r\n  defaultFactory,\r\n  factoriesByType = {},\r\n  onOpen,\r\n  onClose,\r\n  closeOnAction = true,\r\n}) => {\r\n  const [isVisible, setIsVisible] = useState(false);\r\n  const [context, setContext] = useState<EntityContext | undefined>();\r\n  const [menuItems, setMenuItems] = useState<MenuItem[] | undefined>();\r\n  const [isLoading, setIsLoading] = useState(false);\r\n\r\n  const resolveFactory = useCallback(\r\n    (ctx: EntityContext): MenuFactory => {\r\n      if (ctx.entityData?.menuFactory && typeof ctx.entityData.menuFactory === 'function') {\r\n        return ctx.entityData.menuFactory;\r\n      }\r\n      if (ctx.entityType && factoriesByType[ctx.entityType]) {\r\n        return factoriesByType[ctx.entityType];\r\n      }\r\n      return defaultFactory;\r\n    },\r\n    [defaultFactory, factoriesByType],\r\n  );\r\n\r\n  const showMenu = useCallback(\r\n    async (ctx: EntityContext) => {\r\n      setContext(ctx);\r\n      setIsVisible(true);\r\n      setIsLoading(true);\r\n      setMenuItems(undefined);\r\n\r\n      onOpen?.(ctx);\r\n\r\n      try {\r\n        const factory = resolveFactory(ctx);\r\n        const items = await factory(ctx);\r\n        setMenuItems(items);\r\n      } catch (error) {\r\n        console.error('Failed to resolve menu items:', error);\r\n        setMenuItems([]);\r\n      } finally {\r\n        setIsLoading(false);\r\n      }\r\n    },\r\n    [resolveFactory, onOpen],\r\n  );\r\n\r\n  const hideMenu = useCallback(() => {\r\n    setIsVisible(false);\r\n    setContext(undefined);\r\n    setMenuItems(undefined);\r\n    setIsLoading(false);\r\n    onClose?.();\r\n  }, [onClose]);\r\n\r\n  const value: ContextMenuState = {\r\n    isVisible,\r\n    context,\r\n    menuItems,\r\n    isLoading,\r\n    showMenu,\r\n    hideMenu,\r\n  };\r\n\r\n  return <ContextMenuContext.Provider value={value}>{children}</ContextMenuContext.Provider>;\r\n};\r\n"],"mappings":"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","names":["useState","useCallback","jsx","useState","useCallback"]}